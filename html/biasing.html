<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Plumed Tutorial (ASCMS, Sao Paulo, 2011): Biasing collective variables: metadynamics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Plumed Tutorial (ASCMS, Sao Paulo, 2011)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Plumed Tutorial (ASCMS, Sao Paulo, 2011)</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Biasing collective variables: metadynamics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Using PLUMED you can also add a bias on the collective variables. Different biases can be applied, including restraints, soft walls, steered molecular dynamics, metadynamics, etc. We will focus here on metadynamics only.</p>
<p>Metadynamics adds an external potential to the simulation. This bias potential acts on a restricted number of degrees of freedom of the system <img class="formulaInl" alt="$\bm{S}(\bm{R})=(S_1 (\bm{R}),...,S_d(\bm{R}))$" src="form_2.png"/> referred to as collective variables. The metadynamics potential <img class="formulaInl" alt="$V(\bm{S},t)$" src="form_3.png"/> varies with time <img class="formulaInl" alt="$t$" src="form_4.png"/> and is constructed as a sum of Gaussian functions, or hills, deposited during the simulation:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ V(\bm{S},t)=\int_0^t\ dt^\prime \omega\exp\left(-\sum_{i=1}^{d} \frac{(S_i(\bm{R})-S_i(\bm{R}(t^\prime))^2}{2\sigma_i^2} \right), \]" src="form_5.png"/>
</p>
<p>where <img class="formulaInl" alt="$\sigma_i$" src="form_6.png"/> is the Gaussian width corresponding to the i-th CV and <img class="formulaInl" alt="$\omega$" src="form_7.png"/> the rate at which the bias grows. In the practice, Gaussians of height equal to <img class="formulaInl" alt="$W$" src="form_8.png"/> are deposited every <img class="formulaInl" alt="$n$" src="form_9.png"/> MD steps so that <img class="formulaInl" alt="$\omega=W /(n\Delta t) $" src="form_10.png"/> where <img class="formulaInl" alt="$\Delta t$" src="form_11.png"/> is the MD timestep.</p>
<p>In order to perform a metadynamics simulation we have to:</p>
<ul>
<li>Choose wisely the set of CVs to address the problem. This is a long story. To cut it short, CVs should clearly distinguish between the initial state, the final state and the intermediates, should describe all the slow events that are relevant to the process of interest, their number should not be too large, otherwise it will take a very long time to fill the free energy surface.</li>
<li>Choose the Gaussian height <img class="formulaInl" alt="$W$" src="form_8.png"/> and the deposition stride <img class="formulaInl" alt="$\tau=n\Delta t$" src="form_12.png"/> These two variables determine the rate of energy added to your simulation. If this is too large, the free energy surface will be explored at a fast pace, but the reconstructed profile will be affected by large errors. If the rate is small, the reconstruction will be accurate, but it will take a longer time. The error on the reconstructed FES depends on the ratio <img class="formulaInl" alt="$W/\tau$" src="form_13.png"/>, not on the two parameters alone.</li>
<li>Choose the Gaussian width <img class="formulaInl" alt="$\sigma_i$" src="form_6.png"/>. This parameter determines the resolution of the reconstructed FES. The sum of Gaussians reproduces efficiently (i.e. in a finite simulation time) features of the FES on a scale larger than <img class="formulaInl" alt="$\sigma_i$" src="form_6.png"/>. A practical rule is to choose the width as a fraction (half or one third) of the CV fluctuations in an unbiased simulation. This is not a golden rule, since the value of the fluctuations is not universal but usually depends on the position in the CV space.</li>
</ul>
<p>To activate a metadynamics calculation in plumed you have to use the directive <code>HILLS</code>. The deposition stride <img class="formulaInl" alt="$\tau$" src="form_14.png"/> is specified in unit of timestep by the keyword <code>W_STRIDE</code>, the height <img class="formulaInl" alt="$W$" src="form_8.png"/> by <code>HEIGHT</code> in internal units of energy of the MD code used. The Gaussian width <img class="formulaInl" alt="$\sigma_i$" src="form_6.png"/> must be specified on the line of each CVs with the keyword <code>SIGMA</code>.</p>
<p>A typical plumed input file for a metadynamics calculation looks as follows.</p>
<pre class="fragment"># adding a hills of height 0.1 kcal/mol every 0.2 ps
HILLS W_STRIDE 100 HEIGHT 0.1
PRINT W_STRIDE 100
# hills width is 0.35 rad
TORSION LIST 5 7 9 15 SIGMA 0.35
ENDPLUMED
</pre><p>Beside the usual <code>COLVAR</code> file, when you run a metadynamics calculation you get an additional file called <code>HILLS</code> which contains a list of the Gaussians deposited during the simulation. In the example above, this file would look like:</p>
<pre class="fragment">   200.000     -2.210466119      0.350000000      0.100000000   0.000 
   400.000     -1.048053682      0.350000000      0.100000000   0.000 
   600.000     -1.656697613      0.350000000      0.100000000   0.000 
   800.000     -1.219777620      0.350000000      0.100000000   0.000 
...
</pre><p>where:</p>
<ul>
<li>the first column contains the time <img class="formulaInl" alt="$t$" src="form_4.png"/> (in internal unit of the MD code) at which the Gaussian was deposited;</li>
<li>the following <img class="formulaInl" alt="$d$" src="form_15.png"/> columns contain the centroid of the Gaussian, <img class="formulaInl" alt="$S_i(\bm{R}(t))$" src="form_16.png"/>, one for each CV <img class="formulaInl" alt="$i$" src="form_17.png"/>;</li>
<li>the following <img class="formulaInl" alt="$d$" src="form_15.png"/> columns contain the Gaussian sigma <img class="formulaInl" alt="$\sigma_i$" src="form_6.png"/>, one for each CV <img class="formulaInl" alt="$i$" src="form_17.png"/>;</li>
<li>the last but one column contains the value of <img class="formulaInl" alt="$W$" src="form_8.png"/>;</li>
<li>the last column is meaningful only in well-tempered metadynamics simulations (see below). This file contain the history dependent bias and will be used to calculate the estimate of the free-energy at the end of our metadynamics calculation.</li>
</ul>
<p>Beside the metadynamics CVs, we can add other variables that we want to monitor during the simulation. A typical plumed input file looks as: </p>
<pre class="fragment"># adding a hills of height 0.1 kcal/mol every 0.2 ps
HILLS W_STRIDE 100 HEIGHT 0.1
PRINT W_STRIDE 100
# hills width is 0.35 rad
TORSION LIST 5 7 9 15 SIGMA 0.35
# this variable is only monitored - PLUMED knows it from the missing SIGMA keyword
TORSION LIST 7 9 15 17 
ENDPLUMED
</pre><p>The evolution of the additional variable can be monitored by looking at the <code>COLVAR</code> file.</p>
<pre class="fragment">#! FIELDS time cv1 cv2 vbias vwall vext
     0.000     -2.845176229      3.140506206      0.000000000      0.000000000
   200.000     -2.210466119      2.280498229      0.100000000      0.000000000
   400.000     -1.048053682      1.577151570      0.100402547      0.000000000
   600.000     -1.656697613      0.902848655      0.150649018      0.000000000
   800.000     -1.219777620      0.207215863      0.236358998      0.000000000
</pre><div class="image">
<img src="meta.png" alt="meta.png"/>
</div>
 <div class="image">
<img src="rama_meta.png" alt="rama_meta.png"/>
</div>
<p>Notice that now the fourth column is different from zero, as it contains the history dependent potential which is growing during the simulation.</p>
<h1><a class="anchor" id="restarting"></a>
Restarting metadynamics</h1>
<p>In order to restart a metadynamics run, the flag <code>RESTART</code> must be added on the line of the directive <code>HILLS</code>. This allows a metadynamics simulation to be restarted after an interruption or after a run has finished. The <code>HILLS</code> files will be read at the beginning of the simulation and the bias potential applied to the dynamics. Note that the presence of the <code>RESTART</code> flag only affects the metadynamics part of the simulation, and thus the usual procedure for restarting a MD run must be followed. This depends on the particular MD engine used and can be found in the relative documentation. The following is an example of input file for restarting a metadynamics simulation. </p>
<pre class="fragment">HILLS W_STRIDE 100 HEIGHT 0.1 RESTART
PRINT W_STRIDE 100
# hills width is 0.35 rad
TORSION LIST 5 7 9 15 SIGMA 0.35
ENDPLUMED
</pre><h1><a class="anchor" id="fes"></a>
Free-energy reconstruction</h1>
<p>In the long-time limit, the bias potential of metadynamics converges to the free-energy changed in sign. At any time during the simulation we can sum the Gaussians deposited so far and obtain the current estimate of the FES using the utility <code>sum_hills</code>. This code is very flexible and can be executed with several options (see the manual). The most commonly used are:</p>
<pre class="fragment">  sum_hills -file HILLS -out fes.dat -ndim 3 -ndw 1 2 -kt 0.6 -ngrid 100 100
   -file            input file with the list of Gaussians
   -out             output file with the FES
   -ndim            number of collective variables
   -ndw             ID of the variables for FES in output
   -ngrid           grid mesh dimension
   -dp              grid bin size
   -kt              $kT$ in the energy units
   -stride          how often the FES is written
   -2pi             ID of the variables with $[0;2\pi]$ periodicity
   -pi              ID of the variables with $[-\pi;\pi]$ periodicity
</pre><p>The file in output <code>fes.dat</code> contains the estimate of the free-energy calculated on a regular grid whose dimension is specified by either <code>-ngrid</code> or <code>-dp</code>. These parameters should be chosen with care. To calculate accurately the potential in a given point of the CV space, a practical rule is to choose the bin size to be half the Gaussian sigma.</p>
<p>Typical input choices are </p>
<pre class="fragment"># to reconstruct a two-dimensional FES from a two-variable metadynamics:
$ sum_hills -file HILLS -out fes.dat -ndim 2 -ndw 1 2 -kt 0.6 
# to reconstruct a one-dimensional projected FES (over the first variable) from a two-variable metadynamics:
$ sum_hills -file HILLS -out fes.dat -ndim 2 -ndw 1 -kt 0.6 
# to reconstruct a one-dimensional projected FES (over the second variable) from a two-variable metadynamics:
$ sum_hills -file HILLS -out fes.dat -ndim 2 -ndw 2 -kt 0.6 
# if the two variables are torsions, they are periodic on domain (-pi,pi):
$ sum_hills -file HILLS -out fes.dat -ndim 2 -ndw 1 2 -kt 0.6 -pi 1 2
</pre><p>Forgetting to specify periodicity with -pi is one of the most common errors, so be careful!!!!</p>
<p>The <code>sum_hills</code> code should be used to monitor the convergence of a metadynamics simulation. This can be easily achieved by calculating the estimate of the FES at regular interval in time using the <code>-stride</code> option and then evaluating the free-energy difference among relevant regions (minima) of the FES as a function of time.</p>
<p>With the following command </p>
<pre class="fragment">sum_hills.x -fes HILLS -ndim 1 -ndw 1 -pi 1 -stride 50
</pre><p> you will obtain several <code>fes.dat.xx</code> files which represent the estimates of the free energy with an interval of 5 ps</p>
<div class="image">
<img src="fes.png" alt="fes.png"/>
</div>
<p>Below we report an example of bash script that can be used for this purpose. Here we performed a metadynamics calculation using 1 CVs. We define two regions in the CV space: F=[-3:-1] and U=[0:2], which approximately contain the two relevant minima. The free-energy difference between F and U is calculated as a function of time and saved in the file <code>DeltaF</code> </p>
<pre class="fragment">#!/bin/bash
sum_hills.x -stride 10 -ndim 1 -ndw 1 -ngrid 100 100 -kt 0.6 -file HILLS -pi 1
for file in fes.dat.? fes.dat.?? fes.dat.???
 do
  if [ -f ${file} ]; then
    F=`awk 'BEGIN{tot=0}{if(NF==2 &amp;&amp; $1&gt;-3.0 &amp;&amp; $1&lt;-1.0)tot=tot+exp(-$2/0.6)}END{print -0.6*log(tot)}' $file`
    U=`awk 'BEGIN{tot=0}{if(NF==2 &amp;&amp; $1&gt;0.0 &amp;&amp; $1&lt;2.0)tot=tot+exp(-$2/0.6)}END{print -0.6*log(tot)}' $file`
    delta=`echo "$F - $U" | bc -l`
    echo $delta
  fi
done &gt; DeltaF
</pre><div class="image">
<img src="deltaf.png" alt="deltaf.png"/>
</div>
<p>Under proper conditions, in can be shown that the estimates oscillates around the correct value. It is thus possible to have a better estimate of the free energy difference by taking the time average of this estimate.</p>
<p>Notice that the amplitude of the oscillations depends on the rate at which hills are deposited. Play with the parameters to see it!</p>
<h1><a class="anchor" id="welltempered"></a>
Well-tempered metadynamics</h1>
<p>Since the oscillations depends on the hills height, another possible approach to achieve convergence is well-tempered metadynamics. Here the Gaussian height <img class="formulaInl" alt="$W$" src="form_8.png"/> is automatically rescaled during the simulations following: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ W=W_0 \, e^{-\frac{V(\bm{S},t)}{k_B \Delta T}}, \label{WT} \]" src="form_18.png"/>
</p>
<p> where <img class="formulaInl" alt="$W_0$" src="form_19.png"/> is the initial Gaussian height and <img class="formulaInl" alt="$\Delta T$" src="form_20.png"/> a parameter with the dimension of a temperature. The use of well tempered guarantees that the bias potential converges in a single simulation and does not oscillate around the FES value, causing the problem of overfilling: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ V(\bm{S},t \rightarrow \infty) = -\frac{\Delta T}{T + \Delta T} F(\bm{S}) +C, \]" src="form_21.png"/>
</p>
<p> where <img class="formulaInl" alt="$T$" src="form_22.png"/> is the temperature of the system and <img class="formulaInl" alt="$C$" src="form_23.png"/> a constant.</p>
<p>The quantity <img class="formulaInl" alt="$T+\Delta T$" src="form_24.png"/> is often referred to as the (fictitous) CV temperature, while the ratio <img class="formulaInl" alt="$(T+\Delta T) / T$" src="form_25.png"/> as bias factor. To perform a WT metadynamics simulation with plumed you have to use the directive <code>WELLTEMPERED</code> and specify one of the parameters described above using either the keyword <code>CV_TEMPERATURE</code> or <code>BIASFACTOR</code>. In addition, the temperature of the system must be specified explicitly with <code>SIMTEMP</code>.</p>
<dl class="section attention"><dt>Attention</dt><dd>Due to a known bug in the PLUMED-cp.x interface, the Boltzmann constant is wrongly expressed in Ry/K even with cp.x. Thus, if you have to provide a temperature in the plumed.dat file and you are using PLUMED with cp.x, use half of the physical temperature (e.g., for a simulation at 300 use <code>SIMTEMP</code> 150). This is not a problem for the present tutorial since we are only using pw.x. Moreover, this problem has been solved in the PLUMED version from QE website, where Rydberg units are used for both pw.x and cp.x</dd></dl>
<p>Here are some practical rules to choose wisely the parameters in WT metadynamics simulations:</p>
<ul>
<li>The bias factor (or equivalently the CV temperature) regulates how fast the amount of bias potential added decreases with simulation time and eventually controls the extent of exploration. The choice of these parameters depends on the typical free-energy barriers involved in the process under study. In biomolecular simulation, a bias factor of 10-15 which corresponds to barriers of the order of 6-9 kcal/mol at 300K is usually appropriate. Note that this parameter can be changed on-the-fly as needed.</li>
</ul>
<ul>
<li>The optimal choice of the initial Gaussian height $W_0$ is less crucial and at the same time less trivial. It is irrilevant in the long time regime and affects only the transient part of the simulation. A short initial filling period can be desirable if the transverse degrees of freedom relax quickly, otherwise a moderate initial energy rate is a better choice.</li>
</ul>
<p>The following is an example of input file for a WT metadynamics simulation at 300 (internal units of temperature) with a bias factor equal to 10 and an initial Gaussian height of 0.4 (kcal/mol) </p>
<pre class="fragment"># adding a hills of height 0.1 kcal/mol every 0.2 ps
HILLS W_STRIDE 100 HEIGHT 0.1
WELLTEMPERED SIMTEMP 300 BIASFACTOR 10
PRINT W_STRIDE 100
# hills width is 0.35 rad
TORSION LIST 5 7 9 15 SIGMA 0.35
# this variable is only monitored - PLUMED knows it from the missing SIGMA
# keyword
TORSION LIST 7 9 15 17
ENDPLUMED
</pre><p>In WT metadynamics, the Gaussians height as written in the <code>HILLS</code> file is multiplied by the factor <img class="formulaInl" alt="$(T+\Delta T)/ \Delta T$" src="form_26.png"/>. This guarantees that when you sum the Gaussians (by means for example of the <code>sum_hills</code> code) you get directly the FES. The last column of the <code>HILLS</code> file contains the value of the bias factor used in the WT metadynamics simulation. For the example above, this file would look like: </p>
<pre class="fragment">   200.000     -2.210466119      0.350000000      0.111111111   10.000 
   400.000     -1.048053682      0.350000000      0.111102775   10.000 
   600.000     -1.656696885      0.350000000      0.110067210   10.000 
   800.000     -1.219854752      0.350000000      0.108331640   10.000 
  1000.000     -1.520507160      0.350000000      0.106770895   10.000 
  1200.000     -1.238176320      0.350000000      0.104998128   10.000 
  1400.000     -1.374727501      0.350000000      0.103010533   10.000 
  1600.000     -1.284902815      0.350000000      0.101324392   10.000 
  1800.000     -1.463756025      0.350000000      0.100049686   10.000 
  2000.000     -1.339514323      0.350000000      0.097986463   10.000 
</pre><div class="image">
<img src="deltaf-wt.png" alt="deltaf-wt.png"/>
</div>
<p>A further effect of the <code>BIASFACTOR</code> parameter is to tune the explored region of the CV space. This is better seen in two dimensions. Try to perform two dimensional metadynamics using: </p>
<pre class="fragment"># adding a hills of height 0.1 kcal/mol every 0.2 ps
HILLS W_STRIDE 100 HEIGHT 0.1
WELLTEMPERED SIMTEMP 300 BIASFACTOR 10
PRINT W_STRIDE 100
# hills width is 0.35 rad
TORSION LIST 5 7 9 15 SIGMA 0.35
TORSION LIST 7 9 15 17 SIGMA 0.35
ENDPLUMED
</pre><p> and study how the explored domain depends on the choice of <code>BIASFACTOR</code>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jul 29 2013 13:06:13 for Plumed Tutorial (ASCMS, Sao Paulo, 2011) by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
